.. _vac:

Import Visual Approach Charts
=============================

**Enroute Flight Navigation** can import image files with visual approach charts
and display them on the moving map.  The figure :ref:`vacImg` shows how this
will typically look.

.. _vacImg:
.. figure:: ./autogenerated/03-03-VAC.png
   :scale: 30 %
   :align: center
   :alt: Moving map display with approach chart

   Moving map display with embedded approach chart

**Enroute Flight Navigation** accepts visual approach charts in one of the
following formats.

- Geo-referenced image files in GeoTIFF format.

- TripKits that contain collections of approach charts for a specific area or
  flight route. The `AIP Browser DE
  <https://mpmediasoft.de/products/AIPBrowserDE/help/AIPBrowserDE.html>`_ can
  produce TripKits for Germany.

.. note:: GeoTIFF is a complex format that supports many use cases, ranging 
  from astronomy to high-precision land survey. **Enroute Flight Navigation**
  only supports a subset of the GeoTIFF standard. If you encounter a GeoTIFF 
  file that **Enroute Flight Navigation** does not recognize, please 
  `open an issue report 
  <https://github.com/Akaflieg-Freiburg/enroute/issues/new/choose>`_.
  We will be glad to help!


Obtain Approach Chart Files
---------------------------

- Michael Paus' free software `AIP Browser DE
  <https://mpmediasoft.de/products/AIPBrowserDE/help/AIPBrowserDE.html>`_ can
  generate GeoTIFF images and TripKits for all German airfields. The data comes
  from Germany's official `AIP <https://aip.dfs.de/basicAIP>`_, as provided by
  `DFS Deutsche Flugsicherung GmbH <https://www.dfs.de/homepage>`_.

- Advanced users can use the GDAL command line utilities to convert raster
  graphic files into georeferenced GeoTIFF files.  The section :ref:`gdal`
  explains how to do this.

Please get in touch with us if you are aware of other data sources. We will be
glad to list them here.


Import Approach Chart Files
---------------------------
 
Transfer the OpenAir file to your device and open the file on your device.  The
Section :ref:`importData` explains the process in detail.

.. note:: TripKits are ZIP files with specialized content. Trying to open a 
  TripKit file, some file management utilities will automatically unpack the ZIP 
  file rather than offering to open it in **Enroute Flight Navigation**.  Along 
  similar lines, GeoTIFF files are image files with specialized metadata and some
  file management utilities will launch an image viewing application rather than
  offering to open a GeoTIFF file in **Enroute Flight Navigation**.
  
  If you encounter problems opening a TripKit or GeoTIFF file, look for an icon
  or menu item labeled "Open with…".  Some utilities open an appropriate context 
  menu after a tap-and-hold gesture.


Manage Your Approach Chart Library
----------------------------------

On the moving map screen, open the main menu and go to "Library/Maps and Data".
The page "Map and Data Library" will then open. The page has a "VAC" tab listing
the approach charts. Use the context menus to uninstall charts and retrieve
basic information.

The three-dot menu at the top right of the screen allows clearing your approach
chart library.


Use Approach Charts
-------------------

Once approach charts are installed, open the main menu and go to "Approach
Charts". The page "Visual Approach Charts" will then open. The page lists all
approach charts installed in your device, sorted by distance to the current
position. Tap on a chart to open "Approach Chart" page, which shows a slightly
simplified moving map with the approach chart superimposed on top of the usual
map layer. As usual, tap on the left arrow symbol in the page title to close the
page and return to the standard moving map display.

In order to avoid surprises in flight, **Enroute Flight Navigation** will not
open the approach chart page automatically.

.. note:: The menu entry "Approach Charts" is only visible if approach
  charts are installed on your device. If you cannot find the menu entry, 
  install some approach charts first.

.. _gdal:

Appendix: Create Approach Charts with GDAL
------------------------------------------

Advanced users might wish to create their own approach chart files in GeoTIFF
format, perhaps from a PDF of their official AIP.  One user has kindly provided
the following tutorial, which explains how to accomplish this task on a Windows
computer, using command line utilities.

**Preparation**

1. Download and install `Google Earth for Windows
   <https://maps.google.com/intl/en/earth/versions/#download-pro>`_.

2. Download and install `GDAL for Windows <https://gdal.org/download.html>`_.
   GDAL is a translator for raster and vector geospatial data formats.


**Georeferencing and conversion to GeoTIFF**

1. Download the relevant chart from the AIP. The chart will typically come as a
   PDF file.

2. Convert the relevant page of the AIP to PNG format. Most PDF viewer programs
   allow exporting a page to PNG.

3. Use any image viewer program (for instance: Windows Photos) to crop the PNG,
   removing margins and legends and leaving only the parts that you would like
   to see in **Enroute Flight Navigation**. Copy the obtained file to the folder
   where you installed GDAL.

4. Open Google Earth.

5. In the top menu, go to "Add" → "Image overlay."

6. Click on "Browse" and select PNG file created in step 3.

7. Set the "Transparency" to 50% between "Clear" and "Opaque."

8. Before pressing OK, adjust the image size, as it will be quite large, and
   move it to the airport area you're interested in. Since it is transparent,
   you can adjust the size and position until roads and rivers align with the
   Google Earth image underneath. It's not a very fast method, but you can
   change the transparency to check alignment.

9. When the graphic is aligned with the map, press OK.

10. Move the mouse to the upper-left corner of the VAC and note the coordinates
    at the bottom of the screen. Move the mouse to the lower-left corner of the
    VAC and note the coordinates.

11. Open a console by typing "CMD" in the command line. Navigate to the
    directory where you installed GDAL.

12. Type "SDKShell" and press Enter, this sets the paths

13. Convert the PNG file to GeoTIFF format using a GDAL command as follows::

      gdal_translate -a_srs EPSG:4326 -a_ullr <upper_left_longitude> <upper_left_latitude> <lower_right_longitude> <lower_right_latitude> -mo "TIFFTAG_IMAGEDESCRIPTION=Chart Name" -co COMPRESS=LZW input.png output.tif
    
    In the coordinates, north is positive, south is negative, east is positive,
    west is negative.  A call for a map in norther Spain could read as follows::

      gdal_translate -a_srs EPSG:4326 -a_ullr -6.620555 43.982777 -5.736666 43.387222 -mo "TIFFTAG_IMAGEDESCRIPTION=Asturias" -co COMPRESS=LZW input.png output.tif

14. Copy the output.tif file to your mobile device and import it into **Enroute
    Flight Navigation** as described above.
